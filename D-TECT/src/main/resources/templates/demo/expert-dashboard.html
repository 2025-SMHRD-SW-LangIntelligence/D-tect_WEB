<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <title>전문가 대시보드</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{margin:0;background:#f6f7fb;font:14px/1.5 system-ui}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:18px;border:1px solid #e9e9ef}
    h1{margin:0 0 12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input{padding:9px 10px;border:1px solid #e9e9ef;border-radius:10px}
    .btn{background:#111;color:#fff;border:0;border-radius:10px;padding:9px 14px;cursor:pointer}
    .btn.ok{background:#18a058}
    .btn.warn{background:#c0362c}
    .btn.outline{background:#fff;color:#111;border:1px solid #e9e9ef}
    .help{color:#666;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #e9e9ef;text-align:left;vertical-align:top}
    .list{max-height:360px;overflow:auto;border:1px solid #e9e9ef;border-radius:10px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>전문가 대기중 요청</h1>

    <div class="row">
      <form action="/demo/expert-dashboard" method="get" class="row">
        <input type="number" name="expertId" th:value="${expertId} ?: 1" placeholder="expertId"/>
        <button class="btn" type="submit">서버 렌더링으로 보기</button>
      </form>
      <button class="btn outline" id="btnLoad">API로 불러오기</button>
      <span class="help">API: GET /api/matching/requests?expertId=…</span>
    </div>

    <!-- 서버가 pending 모델을 채워준 경우 -->
    <div class="list" style="margin-top:10px" th:if="${pending}">
      <table>
        <thead><tr><th>ID</th><th>사용자</th><th>메시지</th><th>첨부</th><th>요청시각</th><th>처리</th></tr></thead>
        <tbody>
        <tr th:each="m : ${pending}">
          <td th:text="${m.matchingIdx}">10</td>
          <td th:text="${m.user != null ? (m.user.member != null ? m.user.member.name : 'user#'+m.user.userIdx) : ''}">사용자</td>
          <td th:text="${m.requestMessage}">요청내용</td>
          <td><a class="btn outline" th:href="@{'/matching/attachment/' + ${m.matchingIdx}}">첨부 다운로드</a></td>
          <td th:text="${m.requestedAt}">2025-08-18</td>
          <td>
            <form action="/matching/approve" method="post" style="display:inline">
              <input type="hidden" name="matchingId" th:value="${m.matchingIdx}"/>
              <button class="btn ok" type="submit">승인</button>
            </form>
            <form action="/matching/reject" method="post" style="display:inline;margin-left:6px">
              <input type="hidden" name="matchingId" th:value="${m.matchingIdx}"/>
              <button class="btn warn" type="submit">거절</button>
            </form>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- 클라이언트 API 로딩 영역 -->
    <div class="list" style="margin-top:10px" id="box" th:if="${pending} == null">
      <table>
        <thead><tr><th>ID</th><th>사용자</th><th>메시지</th><th>첨부</th><th>요청시각</th><th>처리</th></tr></thead>
        <tbody id="tbody"><tr><td colspan="6" class="help">불러오기 버튼을 누르세요.</td></tr></tbody>
      </table>
    </div>

    <div style="margin-top:12px">
      <a class="btn outline" href="/demo/index">← 데모 홈</a>
    </div>
  </div>
</div>

<script>
  document.getElementById('btnLoad').addEventListener('click', async ()=>{
    const expertId = new URLSearchParams(location.search).get('expertId') || '1';
    const tbody = document.getElementById('tbody');
    try{
      const res = await fetch('/api/matching/requests?expertId='+encodeURIComponent(expertId));
      const rows = await res.json();
      if(!Array.isArray(rows)||rows.length===0){
        tbody.innerHTML = `<tr><td colspan="6" class="help">대기중 요청이 없습니다.</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map(m=>{
        const userName = m.user && m.user.member ? m.user.member.name : `user#${m.user?.userIdx ?? ''}`;
        return `
        <tr>
          <td>${m.matchingIdx}</td>
          <td>${userName}</td>
          <td>${escapeHtml(m.requestMessage||'')}</td>
          <td><a class="btn outline" href="/matching/attachment/${m.matchingIdx}">첨부 다운로드</a></td>
          <td>${m.requestedAt||''}</td>
          <td>
            <form action="/matching/approve" method="post" style="display:inline">
              <input type="hidden" name="matchingId" value="${m.matchingIdx}"/>
              <button class="btn ok" type="submit">승인</button>
            </form>
            <form action="/matching/reject" method="post" style="display:inline;margin-left:6px">
              <input type="hidden" name="matchingId" value="${m.matchingIdx}"/>
              <button class="btn warn" type="submit">거절</button>
            </form>
          </td>
        </tr>
      `;
      }).join('');
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="6" class="help">불러오기 실패: ${e.message}</td></tr>`;
    }
  });
  function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
</script>
</body>
</html>
