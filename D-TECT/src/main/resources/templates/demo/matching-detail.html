<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <title>매칭 상세 · 파일 업/다운로드</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{margin:0;background:#f6f7fb;font:14px/1.5 system-ui}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:18px;border:1px solid #e9e9ef}
    h1{margin:0 0 12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input{padding:9px 10px;border:1px solid #e9e9ef;border-radius:10px}
    .btn{background:#111;color:#fff;border:0;border-radius:10px;padding:9px 14px;cursor:pointer}
    .btn.ok{background:#18a058}
    .btn.warn{background:#c0362c}
    .btn.outline{background:#fff;color:#111;border:1px solid #e9e9ef}
    .help{color:#666;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #e9e9ef;text-align:left}
    .list{max-height:360px;overflow:auto;border:1px solid #e9e9ef;border-radius:10px}
    .pill{display:inline-block;background:#eef;color:#224;border-radius:999px;padding:3px 8px;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>매칭 상세</h1>

    <div class="row">
      <form action="/demo/matching-detail" method="get" class="row">
        <input type="number" name="matchingId" th:value="${matchingId}" placeholder="matchingId"/>
        <button class="btn" type="submit">열기</button>
      </form>
      <button class="btn outline" id="btnLoad">목록(API)</button>
      <span class="help">API: GET /api/uploads?matchingId=…</span>
    </div>

    <!-- 업로드(다중) -->
    <div style="margin-top:12px">
      <h3>다중 파일 업로드</h3>
      <form action="/upload" method="post" enctype="multipart/form-data" class="row">
        <input type="number" name="matchingId" th:value="${matchingId}" placeholder="matchingId" required/>
        <input type="file" name="files" multiple required/>
        <button class="btn" type="submit">업로드</button>
      </form>
      <p class="help">POST /upload (matchingId, files[])</p>
    </div>

    <!-- 업로드 목록 (서버가 모델로 채워준 경우) -->
    <div class="list" style="margin-top:10px" th:if="${uploads}">
      <table>
        <thead><tr><th>Upload ID</th><th>파일명</th><th>파일 ID</th><th>다운로드</th></tr></thead>
        <tbody>
        <tr th:each="u : ${uploads}">
          <td th:text="${u.uploadIdx}" rowspan="999" th:rowspan="${#lists.size(u.uploadFileList)}">U</td>
          <td colspan="3" th:if="${#lists.isEmpty(u.uploadFileList)}"><span class="help">파일 없음</span></td>
          <th:block th:each="f : ${u.uploadFileList}">
            <tr>
              <td th:text="${f.fileName}">file</td>
              <td th:text="${f.fileIdx}">id</td>
              <td><a class="btn outline" th:href="@{'/download/file/' + ${f.fileIdx}}">다운로드</a></td>
            </tr>
          </th:block>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- 업로드 목록 (클라이언트 API로 로딩) -->
    <div class="list" style="margin-top:10px" id="box" th:if="${uploads} == null">
      <table>
        <thead><tr><th>Upload ID</th><th>파일명</th><th>파일 ID</th><th>다운로드</th></tr></thead>
        <tbody id="tbody"><tr><td colspan="4" class="help">목록(API)을 누르세요.</td></tr></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:12px">
      <form action="/matching/complete" method="post" class="row">
        <input type="number" name="matchingId" th:value="${matchingId}" placeholder="matchingId"/>
        <button class="btn ok" type="submit">매칭 완료</button>
      </form>
      <form action="/matching/cancel" method="post" class="row">
        <input type="number" name="matchingId" th:value="${matchingId}" placeholder="matchingId"/>
        <button class="btn warn" type="submit">매칭 취소</button>
      </form>
    </div>

    <div style="margin-top:12px">
      <a class="btn outline" href="/demo/index">← 데모 홈</a>
    </div>
  </div>
</div>

<script>
document.getElementById('btnLoad').addEventListener('click', async ()=>{
  const params = new URLSearchParams(location.search);
  const matchingId = params.get('matchingId') || (document.querySelector('input[name="matchingId"]')?.value || '');
  if (!matchingId) { alert('matchingId를 입력하세요.'); return; }

  const tbody = document.getElementById('tbody');
  try{
    const res = await fetch('/api/uploads?matchingId='+encodeURIComponent(matchingId));
    const items = await res.json();
    if(!Array.isArray(items) || items.length===0){
      tbody.innerHTML = `<tr><td colspan="4" class="help">파일이 없습니다.</td></tr>`;
      return;
    }
    // [{uploadIdx, files:[{fileIdx,fileName}]}] 또는 평탄형 대응
    const rows=[];
    for(const it of items){
      if(Array.isArray(it.files)){
        for(const f of it.files){
          rows.push({uploadIdx:it.uploadIdx,fileIdx:f.fileIdx,fileName:f.fileName||'download.bin'});
        }
      }else{
        rows.push({uploadIdx:it.uploadIdx,fileIdx:it.fileIdx,fileName:it.fileName||'download.bin'});
      }
    }
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r.uploadIdx ?? ''}</td>
        <td>${escapeHtml(r.fileName)}</td>
        <td>${r.fileIdx}</td>
        <td><a class="btn outline" href="/download/file/${r.fileIdx}">다운로드</a></td>
      </tr>
    `).join('');
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="4" class="help">불러오기 실패: ${e.message}</td></tr>`;
  }
});
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
</script>
</body>
</html>
