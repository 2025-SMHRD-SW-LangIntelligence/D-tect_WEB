<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>D-tect | 법률 전문가 문의 · 결제</title>

    <link rel="stylesheet" th:href="@{/css/user/inquiry_checkout.css}" />
    <script src="https://js.tosspayments.com/v1"></script>
</head>

<body class="page"
      th:data-user-id="${userId}"
      th:data-error="${error}">
<div class="brand-strip"></div>

<main class="container">
    <!-- 변호사 정보 / 요금 안내 -->
    <section class="card">
        <div class="lawyer-head">
            <div class="lawyer-name" id="lawyerName"
                 th:text="${expert.member.name} + ' 법률 전문가'">- 법률 전문가</div>
            <div class="tags" id="lawyerTags"></div>
        </div>

        <div class="fee-box">
            <div class="fee-title">상담료 안내 (보기 전용)</div>
            <div class="fee-list" id="feeList">
                <span class="fee-pill"><b>기본상담 30분</b> 30,000원</span>
                <span class="fee-pill"><b>심화상담 60분</b> 50,000원</span>
                <span class="fee-pill"><b>문서 검토</b> 70,000원</span>
            </div>
            <p class="muted">
                결제는 <b>기본상담(30분)</b> 기준으로 진행됩니다. 심화상담/문서검토는 상담 후 별도 합의·결제로 진행될 수 있습니다.
            </p>
        </div>

        <div class="mode-line">
            <span class="badge-fixed">상담 방식: 채팅</span>
        </div>

        <p class="notice-red">
            상담 진행 시 비용이 발생합니다. 실제 금액은 관리자/법률 전문가가 조정할 수 있습니다.
        </p>
    </section>

    <!-- 상담 설명 / 유형 / 파일 / 전송 -->
    <section class="card dark">
        <form id="requestForm" th:action="@{/matching/request}" method="post" enctype="multipart/form-data">

            <input type="hidden" name="userId"   th:value="${userId}" />
            <input type="hidden" name="expertId" th:value="${expert.expertIdx}" />
            <input type="hidden" name="requestReason" id="requestReason" /> <!-- 선택된 코드가 들어감 -->

            <label class="field-label">법률 전문가에게 전달할 상담 설명</label>
            <textarea id="message" name="message" class="textbox"
                      placeholder="상황 설명, 요청사항 등을 자세히 적어주세요." rows="6"></textarea>

            <div class="field-label mt8">
                상담받으실 유형(피해 유형) <small class="muted">(최대 1개 선택)</small>
            </div>

            <div id="issueChips" class="chips">
                <button type="button" class="chip"
                        th:each="ct : ${consultTypes}"
                        th:data-code="${ct.code}"
                        th:text="${ct.label}">라벨</button>
            </div>

            <div class="row">
                <div class="file-wrap">
                    <input id="upload" type="file" name="attachment" accept=".pdf" hidden />
                    <button id="fileBtn" type="button" class="btn btn-ghost">PDF 첨부하기</button>
                    <small id="fileHint" class="muted">※ 결과보고서 PDF 파일 첨부는 <b>필수</b>입니다.</small>
                    <span id="fileName" class="file-name" hidden></span>
                </div>
            </div>

            <div class="actions">
                <button id="submitBtn" class="btn btn-primary" type="submit">전송</button>
            </div>
        </form>
    </section>
</main>

<script>
    (function () {
        var serverError = document.body.dataset.error;
        if (serverError) alert(serverError);
    })();

    // 파일 업로드 표시
    const fileBtn    = document.getElementById("fileBtn");
    const upload     = document.getElementById("upload");
    const fileNameEl = document.getElementById("fileName");
    fileBtn.addEventListener("click", () => upload.click());
    upload.addEventListener("change", () => {
        const name = upload.files && upload.files[0] ? upload.files[0].name : "";
        if (name) {
            fileNameEl.textContent = name;
            fileNameEl.hidden = false;
            fileHint.hidden = true;
        } else {
            fileNameEl.textContent = "";
            fileNameEl.hidden = true;
            fileHint.hidden = false;
        }
    });

    const chips        = document.getElementById("issueChips");
    const hiddenReason = document.getElementById("requestReason");
    chips.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip"); if (!btn) return;
        const all = [...chips.querySelectorAll(".chip")];
        if (btn.classList.contains("is-selected")) {
            btn.classList.remove("is-selected");
            hiddenReason.value = "";
            return;
        }
        all.forEach(b => b.classList.remove("is-selected"));
        btn.classList.add("is-selected");
        hiddenReason.value = btn.dataset.code; // 코드(VIOLENCE 등) 저장
    });

    // 제출 처리
    const form      = document.getElementById("requestForm");
    const submitBtn = document.getElementById("submitBtn");
    const messageEl = document.getElementById("message");

    form.addEventListener("submit", (e) => {
        const msg = (messageEl.value || "").trim();

        if (msg.length < 5) {
            e.preventDefault();
            alert("상담 설명을 5자 이상 작성해주세요.");
            messageEl.focus();
            return;
        }
        if (!hiddenReason.value) {
            e.preventDefault();
            alert("상담 유형을 1개 선택해주세요.");
            return;
        }
        const f = upload.files?.[0];
        if (!f) {
            e.preventDefault();
            alert("PDF 첨부는 필수입니다.");
            return;
        }

        if (!/\.pdf$/i.test(f.name) || (f.type && f.type !== 'application/pdf')) {
            e.preventDefault();
            alert("PDF 파일만 첨부할 수 있습니다.");
            return;
        }

        if (submitBtn.disabled) {
            e.preventDefault();
            return;
        }
        submitBtn.disabled = true;
        submitBtn.textContent = "전송 중...";

        setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = "전송";
        }, 8000);
    });
</script>

</body>
</html>
